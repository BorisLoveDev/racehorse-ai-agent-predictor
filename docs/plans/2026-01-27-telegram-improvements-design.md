# Telegram Bot Improvements Design

## Overview

–£–ª—É—á—à–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ Telegram-–±–æ—Ç–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞–≤–æ–∫.

## –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã

1. –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (odds) –Ω–∞ —Å—Ç–∞–≤–∫–∏
2. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–∏–∫—Ç–æ–º
3. –ù–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –±–æ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç —à—É–º

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —É–∂–µ –ø–∞—Ä—Å—è—Ç—Å—è –≤ `TabTouchParser` –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∞–≥–µ–Ω—Ç–∞–º. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î:**

```sql
-- predictions: –¥–æ–±–∞–≤–∏—Ç—å —Å–Ω–∏–º–æ–∫ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–µ–¥–∏–∫—Ç–∞
ALTER TABLE predictions ADD COLUMN odds_snapshot_json TEXT;

-- prediction_outcomes: –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã
ALTER TABLE prediction_outcomes ADD COLUMN actual_dividends_json TEXT;
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `odds_snapshot_json`:**
```json
{
  "win": {"3": 2.30},
  "place": {"3": 1.40},
  "exacta": {"3-7": 15.50},
  "trifecta": {"3-7-5": 85.00}
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `actual_dividends_json`:**
```json
{
  "win": {"3": 1.65},
  "place": {"3": 1.14, "6": 1.90},
  "exacta": {"3-6": 4.10},
  "trifecta": {"3-6-10": 21.20},
  "first4": {"3-6-10-9": 80.20}
}
```

### 2. –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

#### –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–¥–∏–∫—Ç–µ (—Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏)

```
üèá New Prediction - Gemini
Race: Ascot R4
Confidence: 75%
Risk Level: Medium

Analysis:
[—Ç–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑ –¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤...]

Recommended Bets:
  üí∞ Win #3 Enrich The Heart @2.30 ‚Üí $10 (potential: $23)
  üìç Place #3 @1.40 ‚Üí $5 (potential: $7)
  üéØ Exacta 3-7 @15.50 ‚Üí $5 (potential: $77.50)

Key Factors:
  ‚Ä¢ Factor 1
  ‚Ä¢ Factor 2

Total: $20 | Potential: $107.50
```

#### –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (—Å –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º)

```
‚úÖ Race Result - Gemini
Race: Ascot R4

Finishing Order:
  1. #3 Enrich The Heart
  2. #6 Ruby Marvel
  3. #10 Hayatenoshinnosuke

Bet Results:
  ‚úÖ Win #3: @2.30 ‚Üí @1.65 = +$16.50
  ‚úÖ Place #3: @1.40 ‚Üí @1.14 = +$5.70
  ‚ùå Exacta 3-7: (actual 3-6 paid $4.10)

Total Bet: $20.00
Total Won: $22.20
PROFIT: +$2.20
```

**–í–∞–∂–Ω–æ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É–±–∏—Ä–∞–µ—Ç—Å—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–º–∞–Ω–¥–µ `/stats`.

### 3. –ö–æ–º–∞–Ω–¥—ã Telegram –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/races` | –°–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–µ–∑–¥–æ–≤ (–¥–æ 10) |
| `/status` | –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏, –æ–∂–∏–¥–∞—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ |
| `/history` | –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `/history N` | –ü–æ—Å–ª–µ–¥–Ω–∏–µ N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è |
| `/stats today` | –ó–∞ —Å–µ–≥–æ–¥–Ω—è |
| `/stats 3d` | –ó–∞ 3 –¥–Ω—è |
| `/stats week` | –ó–∞ –Ω–µ–¥–µ–ª—é |

#### –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤

**`/races`:**
```
üèá Upcoming Races:
‚Ä¢ Ascot R4 ‚Äî 14:35 (12m)
‚Ä¢ Flemington R2 ‚Äî 14:50 (27m)
‚Ä¢ Randwick R6 ‚Äî 15:05 (42m)
‚Ä¢ Moonee Valley R1 ‚Äî 15:20 (57m)
```

**`/status`:**
```
‚è≥ Active Bets (2):

Ascot R4 ‚Äî starts 14:35 (12m)
  Gemini: Win #3 @2.30, Exacta 3-7 @15.50
  Grok: Win #3 @2.30, Place #5 @1.80

Flemington R2 ‚Äî starts 14:50 (27m)
  Gemini: Win #1 @3.10
```

**`/stats week`:**
```
üìä Statistics (Last 7 days)

Gemini:
  Predictions: 24
  Bets: 45 (18W-27L)
  Win Rate: 40.0%
  ROI: +12.5%
  P/L: +$156.00

Grok:
  Predictions: 24
  Bets: 52 (15W-37L)
  Win Rate: 28.8%
  ROI: -8.2%
  P/L: -$94.00

Combined P/L: +$62.00

üìÖ Periods: today, 3d, week, all
Usage: /stats today
```

### 4. –ì—Ä–∞—Ñ–∏–∫ P/L

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `/stats` (–ª—é–±–æ–π –ø–µ—Ä–∏–æ–¥) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:

- **–¢–∏–ø:** –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
- **–û—Å—å X:** –ó–∞–µ–∑–¥—ã (–ø–æ –≤—Ä–µ–º–µ–Ω–∏)
- **–û—Å—å Y:** –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π P/L
- **–õ–∏–Ω–∏–∏:** –ü–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (—Ä–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞)
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** matplotlib

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
üìä Statistics (Last 7 days)
[–≥—Ä–∞—Ñ–∏–∫ –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]

Gemini: +$156.00 (‚Üë12.5% ROI)
Grok: -$94.00 (‚Üì8.2% ROI)
Combined: +$62.00

üìÖ Periods: today, 3d, week, all
```

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å `odds_snapshot_json` –≤ predictions
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å `actual_dividends_json` –≤ prediction_outcomes

### –≠—Ç–∞–ø 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- [ ] Orchestrator: –∏–∑–≤–ª–µ–∫–∞—Ç—å odds –∏–∑ race_data –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–æ—à–∞–¥–µ–π
- [ ] Orchestrator: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `odds_snapshot_json`
- [ ] Results service: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å dividends –≤ `actual_dividends_json`

### –≠—Ç–∞–ø 3: Telegram —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `_format_prediction_message()` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å odds –∏ potential payout
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `_format_result_message()` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ odds
- [ ] –£–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### –≠—Ç–∞–ø 4: –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å aiogram Dispatcher –∏ handlers
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/races` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –±–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–µ–∑–¥–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/status` ‚Äî –∑–∞–ø—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –∏–∑ –ë–î
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/history [N]` ‚Äî –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/stats [period]` ‚Äî –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º

### –≠—Ç–∞–ø 5: –ì—Ä–∞—Ñ–∏–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å matplotlib –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≥—Ä–∞—Ñ–∏–∫–∞ P/L –ø–æ –∑–∞–µ–∑–¥–∞–º
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≥—Ä–∞—Ñ–∏–∫–∞ –≤ `/stats`

### –≠—Ç–∞–ø 6: Repositories
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (today, 3d, week)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞ (P/L –ø–æ –∑–∞–µ–∑–¥–∞–º —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –∞–≥–µ–Ω—Ç–∞–º)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ù–æ–≤—ã–µ:**
- matplotlib

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ:**
- aiogram (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- aioredis (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- sqlite3 (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

## –ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã

1. `src/database/migrations.py` ‚Äî –Ω–æ–≤—ã–µ –ø–æ–ª—è
2. `src/database/repositories.py` ‚Äî –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
3. `services/orchestrator/main.py` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ odds_snapshot
4. `services/results/main.py` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ actual_dividends
5. `services/telegram/main.py` ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ–º–∞–Ω–¥—ã, –≥—Ä–∞—Ñ–∏–∫–∏
6. `requirements.txt` ‚Äî matplotlib
7. `Dockerfile.base` ‚Äî matplotlib (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
